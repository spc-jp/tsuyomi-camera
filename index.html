<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>価値みっけ - SNS×カメラ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* フォント定義 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@600&family=Zen+Maru+Gothic:wght@500;700&display=swap');
        
        :root {
            --gradient-main: linear-gradient(135deg, #1F3A5F 0%, #0F172A 100%);
            --color-sub: #E6E9EF;
            --color-accent: #4DA3FF;
            --color-text: #1F3A5F;
            --font-main: 'Noto Sans JP', sans-serif;
            --font-head: 'Noto Serif JP', serif;
            --radius-btn: 0.5rem;
            --radius-card: 1.5rem;
        }

        /* テーマ定義 */
        body.theme-business {
            --gradient-main: linear-gradient(135deg, #1F3A5F 0%, #0F172A 100%);
            --color-sub: #E6E9EF;
            --color-accent: #4DA3FF;
            --color-text: #1F3A5F;
            --font-main: 'Noto Sans JP', sans-serif;
            --font-head: 'Noto Serif JP', serif;
            --radius-btn: 0.5rem;
            --radius-card: 1rem;
        }

        body.theme-casual {
            --gradient-main: linear-gradient(135deg, #EA580C 0%, #DB2777 100%);
            --color-sub: #FFF7ED;
            --color-accent: #FDBA74;
            --color-text: #431407;
            --font-main: 'Zen Maru Gothic', sans-serif;
            --font-head: 'Zen Maru Gothic', sans-serif;
            --radius-btn: 9999px;
            --radius-card: 2rem;
        }

        body.theme-travel {
            --gradient-main: linear-gradient(135deg, #0D9488 0%, #0F766E 100%);
            --color-sub: #F0FDFA;
            --color-accent: #2DD4BF;
            --color-text: #134E4A;
            --font-main: 'Noto Sans JP', sans-serif;
            --font-head: 'Noto Sans JP', sans-serif;
            --radius-btn: 1rem;
            --radius-card: 1.5rem;
        }

        body.theme-minimal {
            --gradient-main: linear-gradient(135deg, #171717 0%, #404040 100%);
            --color-sub: #FAFAFA;
            --color-accent: #737373;
            --color-text: #171717;
            --font-main: 'Noto Sans JP', sans-serif;
            --font-head: 'Noto Sans JP', sans-serif;
            --radius-btn: 0px;
            --radius-card: 0px;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, #FFFFFF 0%, var(--color-sub) 100%);
            color: var(--color-text);
            touch-action: manipulation;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        h1, h2, .font-head { font-family: var(--font-head); }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .scanning-line {
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-accent), transparent);
            position: absolute; top: 0; left: 0;
            animation: scan 2s ease-in-out infinite;
            box-shadow: 0 0 10px var(--color-accent);
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 15% { opacity: 1; } 85% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .bg-theme-gradient { background: var(--gradient-main); }

        .btn-primary {
            background: var(--gradient-main); color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0, 0.15);
            position: relative; overflow: hidden;
            border-radius: var(--radius-btn);
        }
        .btn-primary:hover { box-shadow: 0 6px 15px rgba(0,0,0, 0.2); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(1px); box-shadow: none; }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent); pointer-events: none;
        }

        .btn-secondary {
            background-color: white; border: 1px solid #CBD5E1; color: var(--color-text);
            transition: all 0.2s; border-radius: var(--radius-btn);
        }
        .btn-secondary:hover { border-color: var(--color-accent); color: var(--color-accent); background-color: #fff; }

        .icon-wrapper { transition: transform 0.2s; cursor: pointer; border-radius: var(--radius-btn); }
        .icon-wrapper:active { transform: scale(0.95); }

        .card-biz {
            background: white; border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-card);
            backdrop-filter: blur(10px);
        }

        .main-container {
            border-radius: var(--radius-card);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
        .color-radio:checked + label { ring-width: 2px; ring-offset-width: 2px; ring-color: var(--color-accent); transform: scale(1.05); }

        /* 追加スタイル */
        .input-area {
            width: 100%;
            padding: 12px;
            border: 1px solid #CBD5E1;
            border-radius: var(--radius-btn);
            resize: vertical;
            font-size: 0.9rem;
            background-color: #F8FAFC;
            transition: border-color 0.2s;
            margin-bottom: 1rem;
        }
        .input-area:focus { outline: none; border-color: var(--color-accent); background-color: #fff; }

        .error-box {
            background-color: #FEF2F2; border: 1px solid #FECACA;
            color: #B91C1C; padding: 1rem; border-radius: var(--radius-btn);
            margin-bottom: 1rem; font-size: 0.85rem;
        }
        .raw-error {
            display: none; margin-top: 0.5rem; padding: 0.5rem;
            background-color: rgba(0,0,0,0.05); font-family: monospace;
            font-size: 0.7rem; white-space: pre-wrap; word-break: break-all;
        }
    </style>
</head>
<body class="theme-business flex flex-col items-center justify-center p-4 sm:p-6">

    <main class="main-container w-full max-w-[400px] bg-white overflow-hidden min-h-[750px] flex flex-col relative ring-1 ring-black/5">
        
        <!-- ヘッダー -->
        <header class="text-white pt-8 pb-6 px-6 text-center relative z-10 transition-all duration-500 bg-theme-gradient">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
            
            <button onclick="openSettings()" class="absolute top-6 right-6 p-2 rounded-full hover:bg-white/20 transition-colors z-20">
                <i data-lucide="settings" class="w-5 h-5 text-white"></i>
            </button>

            <div class="relative">
                <p id="app-subtitle" class="text-[10px] tracking-[0.2em] text-white/80 uppercase mb-3 font-medium">SNS×カメラ</p>
                <h1 class="font-head font-bold text-white flex flex-col items-center gap-1">
                    <span class="text-[11px] font-normal opacity-90 tracking-normal">あなたの中の“強み”を、パッと見える化</span>
                    <span class="text-2xl flex items-center gap-2 tracking-wide mt-1">
                        <i data-lucide="camera" class="w-6 h-6 opacity-90"></i>
                        価値みっけ
                    </span>
                </h1>
            </div>
        </header>

        <div id="app-content" class="flex-1 flex flex-col relative" style="background-color: var(--color-sub); transition: background-color 0.5s;">
            
            <!-- Home -->
            <div id="screen-home" class="flex flex-col items-center justify-between h-full p-6 fade-in overflow-y-auto">
                <div class="flex-1 flex flex-col items-center justify-center space-y-6 w-full">
                    <div class="text-center space-y-4 bg-white p-6 rounded-[inherit] shadow-sm border border-slate-100 w-full card-biz">
                        <div class="inline-flex items-center justify-center w-14 h-14 rounded-full mb-1 transition-colors duration-500" style="background: var(--color-sub);">
                            <i data-lucide="sparkles" class="w-6 h-6" style="color: var(--color-text);"></i>
                        </div>
                        <h2 class="text-base font-bold font-head" style="color: var(--color-text);">
                            あなたの「価値」を<br>言葉にします。
                        </h2>
                        
                        <!-- 補足テキスト入力 -->
                        <div class="w-full text-left" style="margin-top:10px;">
                            <label class="text-xs font-bold opacity-70 mb-1 block">補足文（任意）</label>
                            <textarea id="userText" class="input-area" rows="3" placeholder="例：40代向けの落ち着いたカフェです"></textarea>
                        </div>
                    </div>

                    <div class="w-full space-y-3">
                        <input type="file" id="camera-input" accept="image/*" class="hidden">
                        
                        <!-- ボタン群 -->
                        <button onclick="document.getElementById('camera-input').click()" 
                            class="btn-primary w-full text-white py-4 flex items-center justify-center gap-3 group">
                            <i data-lucide="aperture" class="w-5 h-5 group-hover:rotate-45 transition-transform"></i>
                            <span class="text-base font-bold tracking-wide">写真を選んで解析</span>
                        </button>
                        
                        <button onclick="handleNoImageAnalysis()" 
                            class="btn-secondary w-full py-3 text-xs font-bold flex items-center justify-center gap-2">
                            <i data-lucide="type" class="w-4 h-4"></i>
                            補足文のみで解析
                        </button>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-black/5 w-full">
                    <p class="text-[10px] text-center opacity-50 mb-3 tracking-wider">SHARE ON</p>
                    <div class="flex justify-center gap-6 opacity-60">
                        <i data-lucide="instagram" class="w-5 h-5"></i>
                        <i data-lucide="facebook" class="w-5 h-5"></i>
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span class="text-xs font-bold pt-0.5">LINE</span>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="screen-loading" class="hidden flex flex-col items-center justify-center h-full p-8 gap-8 fade-in">
                <div class="relative w-full aspect-square max-w-[260px] bg-white overflow-hidden shadow-lg border border-black/5 card-biz">
                    <img id="preview-image-loading" class="w-full h-full object-cover opacity-80" src="" alt="解析中">
                    <div class="scanning-line"></div>
                    <div class="absolute inset-0 flex flex-col justify-end p-4">
                        <div class="bg-white/90 backdrop-blur px-4 py-3 rounded-lg text-xs border border-slate-200 shadow-lg" style="color: var(--color-text);">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: var(--color-accent);"></div>
                                <span class="font-bold">Generating...</span>
                            </div>
                            <div class="text-[10px] opacity-70 pl-4">
                                価値を分析中...<br>
                                投稿文を作成中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result -->
            <div id="screen-result" class="hidden flex flex-col h-full fade-in relative" style="background-color: var(--color-sub);">
                
                <!-- 画像ヘッダー -->
                <div class="relative w-full h-40 shrink-0 transition-all duration-500 bg-theme-gradient">
                    <img id="preview-image-result" class="w-full h-full object-cover mix-blend-overlay opacity-50" src="" alt="">
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent">
                        <div class="flex items-center gap-2">
                            <span class="text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm" style="background-color: var(--color-accent);">生成完了</span>
                        </div>
                    </div>
                    <button onclick="resetApp()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-black/30 backdrop-blur-sm text-white flex items-center justify-center hover:bg-black/50 transition-colors z-20 border border-white/20">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- 結果コンテンツ -->
                <div class="flex-1 px-5 py-6 overflow-y-auto -mt-6 relative z-10">
                    
                    <!-- エラー表示エリア -->
                    <div id="error-container" class="hidden error-box">
                        <div class="flex items-center gap-2 font-bold">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span id="error-message">エラーが発生しました</span>
                        </div>
                        <button onclick="toggleRawError()" class="text-xs underline mt-1 opacity-80">詳細を表示</button>
                        <div id="error-raw" class="raw-error"></div>
                    </div>

                    <div id="result-container" class="card-biz p-6 mb-5 relative shadow-lg">
                        
                        <!-- タイトル -->
                        <h3 id="result-title" class="text-lg font-bold mb-4 font-head leading-tight border-b border-black/5 pb-2" style="color: var(--color-text);"></h3>
                        
                        <!-- 投稿文 -->
                        <div id="result-post" class="text-sm leading-7 font-medium mb-4 whitespace-pre-line" style="color: var(--color-text);"></div>
                        
                        <!-- ハッシュタグ -->
                        <div class="p-3 rounded-lg border border-black/5 bg-black/5 mb-4">
                            <p id="result-hashtags" class="text-xs font-mono leading-relaxed" style="color: var(--color-text); opacity: 0.8;"></p>
                        </div>

                        <!-- CTA -->
                        <div class="text-xs font-bold text-center p-2 rounded bg-theme-gradient text-white opacity-90">
                            <i data-lucide="megaphone" class="w-3 h-3 inline mr-1"></i> <span id="result-cta"></span>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="space-y-3">
                        <button onclick="copyAll()" id="btn-copy-all" 
                            class="btn-primary w-full text-white py-3 flex items-center justify-center gap-2 shadow-md">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="font-bold text-sm">投稿セットをコピー</span>
                        </button>
                        
                        <button onclick="copyTitle()" id="btn-copy-title" 
                            class="btn-secondary w-full py-3 text-xs font-bold flex items-center justify-center gap-2">
                            <i data-lucide="type" class="w-4 h-4"></i>
                            タイトルのみコピー
                        </button>

                        <!-- SNSリンク -->
                        <div class="grid grid-cols-4 gap-2 mt-4">
                            <button class="icon-wrapper flex flex-col items-center gap-1 bg-white p-2 border border-slate-200 shadow-sm hover:border-blue-400" onclick="openSNS('instagram')">
                                <i data-lucide="instagram" class="w-5 h-5 text-slate-600"></i>
                                <span class="text-[9px] text-slate-500 font-bold">Insta</span>
                            </button>
                            <button class="icon-wrapper flex flex-col items-center gap-1 bg-white p-2 border border-slate-200 shadow-sm hover:border-blue-600" onclick="openSNS('facebook')">
                                <i data-lucide="facebook" class="w-5 h-5 text-slate-600"></i>
                                <span class="text-[9px] text-slate-500 font-bold">FB</span>
                            </button>
                            <button class="icon-wrapper flex flex-col items-center gap-1 bg-white p-2 border border-slate-200 shadow-sm hover:border-black" onclick="openSNS('twitter')">
                                <svg class="w-5 h-5 text-slate-600 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                <span class="text-[9px] text-slate-500 font-bold">X</span>
                            </button>
                            <button class="icon-wrapper flex flex-col items-center gap-1 bg-white p-2 border border-slate-200 shadow-sm hover:border-green-500" onclick="openSNS('line')">
                                <span class="text-xs font-bold text-slate-600">LINE</span>
                                <span class="text-[9px] text-slate-500 font-bold">LINE</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-white/50 backdrop-blur-sm text-center">
                    <button onclick="resetApp()" class="text-xs font-bold opacity-50 hover:opacity-100 flex items-center justify-center gap-2 transition-all mx-auto">
                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                        新しい写真を解析
                    </button>
                </div>
            </div>
        </div>

        <!-- コピーライト -->
        <footer class="w-full bg-slate-50 border-t border-slate-100 py-2 text-center z-10">
            <p class="text-[10px] text-slate-400 font-medium">テスト版（ベータ版） © 2026 SPC</p>
        </footer>

        <!-- 設定モーダル -->
        <div id="settings-modal" class="hidden absolute inset-0 z-50 modal-overlay flex flex-col justify-end sm:justify-center fade-in">
            <div class="bg-white w-full rounded-t-2xl sm:rounded-2xl sm:w-[90%] sm:mx-auto p-6 shadow-2xl animate-slide-up max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between mb-6 shrink-0">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="palette" class="w-5 h-5 text-slate-500"></i>
                        スタイル & 設定
                    </h2>
                    <button onclick="closeSettings()" class="p-2 -mr-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-6 overflow-y-auto pb-4 flex-1">
                    <div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">アプリの雰囲気を選ぶ</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <input type="radio" name="theme" id="theme-business" value="theme-business" class="hidden color-radio" checked onchange="changeTheme(this.value)">
                                <label for="theme-business" class="block w-full p-3 rounded-xl bg-slate-50 border border-slate-200 cursor-pointer transition-all hover:bg-slate-100">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#1F3A5F] to-[#0F172A]"></div>
                                        <span class="text-sm font-bold text-[#1F3A5F]">Business</span>
                                    </div>
                                    <p class="text-[10px] text-slate-500">信頼・堅実・プロ<br>士業/法人向け</p>
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" name="theme" id="theme-casual" value="theme-casual" class="hidden color-radio" onchange="changeTheme(this.value)">
                                <label for="theme-casual" class="block w-full p-3 rounded-xl bg-orange-50 border border-orange-100 cursor-pointer transition-all hover:bg-orange-100">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#EA580C] to-[#DB2777]"></div>
                                        <span class="text-sm font-bold text-[#EA580C]">Casual</span>
                                    </div>
                                    <p class="text-[10px] text-orange-800/70">親しみ・元気・ポップ<br>カフェ/サロン向け</p>
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" name="theme" id="theme-travel" value="theme-travel" class="hidden color-radio" onchange="changeTheme(this.value)">
                                <label for="theme-travel" class="block w-full p-3 rounded-xl bg-teal-50 border border-teal-100 cursor-pointer transition-all hover:bg-teal-100">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#0D9488] to-[#0F766E]"></div>
                                        <span class="text-sm font-bold text-[#0D9488]">Travel</span>
                                    </div>
                                    <p class="text-[10px] text-teal-800/70">非日常・癒やし・自然<br>観光/宿泊向け</p>
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" name="theme" id="theme-minimal" value="theme-minimal" class="hidden color-radio" onchange="changeTheme(this.value)">
                                <label for="theme-minimal" class="block w-full p-3 rounded-xl bg-gray-50 border border-gray-200 cursor-pointer transition-all hover:bg-gray-100">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#171717] to-[#404040]"></div>
                                        <span class="text-sm font-bold text-[#171717]">Minimal</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500">洗練・中立・シンプル<br>デザイン/建築向け</p>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">リンク先設定 (任意)</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="instagram" class="w-4 h-4 text-slate-400"></i>
                                <input id="input-insta" type="url" placeholder="Instagram URL" class="flex-1 text-xs border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="facebook" class="w-4 h-4 text-slate-400"></i>
                                <input id="input-fb" type="url" placeholder="Facebook URL" class="flex-1 text-xs border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-400 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                <input id="input-x" type="url" placeholder="X (Twitter) URL" class="flex-1 text-xs border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-slate-400 w-4 text-center">L</span>
                                <input id="input-line" type="url" placeholder="LINE Official URL" class="flex-1 text-xs border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100 shrink-0">
                    <button onclick="saveSettings()" class="btn-primary w-full py-3 rounded-lg text-sm font-bold text-white shadow-lg transition-all transform active:scale-95">
                        保存して閉じる
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();

        // Elements
        const fileInput = document.getElementById('camera-input');
        const inputText = document.getElementById('userText'); // userTextに変更
        const screenHome = document.getElementById('screen-home');
        const screenLoading = document.getElementById('screen-loading');
        const screenResult = document.getElementById('screen-result');
        const previewLoading = document.getElementById('preview-image-loading');
        const previewResult = document.getElementById('preview-image-result');
        
        // Result Elements
        const resultTitle = document.getElementById('result-title');
        const resultPost = document.getElementById('result-post');
        const resultHashtags = document.getElementById('result-hashtags');
        const resultCta = document.getElementById('result-cta');
        const resultContainer = document.getElementById('result-container');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const errorRaw = document.getElementById('error-raw');

        // Settings
        const settingsModal = document.getElementById('settings-modal');
        const inputInsta = document.getElementById('input-insta');
        const inputFb = document.getElementById('input-fb');
        const inputX = document.getElementById('input-x');
        const inputLine = document.getElementById('input-line');

        let userSettings = {
            theme: 'theme-business',
            urls: { instagram: '', facebook: '', twitter: '', line: '' }
        };

        // Init
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('bizCameraSettings_v2');
            if (saved) {
                userSettings = JSON.parse(saved);
                applySettings();
            }
        });

        // Theme & Settings
        function changeTheme(themeName) {
            document.body.className = `${themeName} flex flex-col items-center justify-center p-4 sm:p-6 transition-colors duration-300`;
            userSettings.theme = themeName;
        }

        function openSettings() {
            inputInsta.value = userSettings.urls.instagram;
            inputFb.value = userSettings.urls.facebook;
            inputX.value = userSettings.urls.twitter;
            inputLine.value = userSettings.urls.line;
            document.getElementById(userSettings.theme).checked = true;
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() { settingsModal.classList.add('hidden'); }

        function saveSettings() {
            userSettings.urls.instagram = inputInsta.value.trim();
            userSettings.urls.facebook = inputFb.value.trim();
            userSettings.urls.twitter = inputX.value.trim();
            userSettings.urls.line = inputLine.value.trim();
            localStorage.setItem('bizCameraSettings_v2', JSON.stringify(userSettings));
            closeSettings();
        }

        function applySettings() { changeTheme(userSettings.theme); }

        // Image Processing
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const max = 1024;
                        if (width > max) {
                            height = Math.round(height * max / width);
                            width = max;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
                        resolve({
                            base64: dataUrl.split(',')[1],
                            mime: 'image/jpeg',
                            preview: dataUrl
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // API Call
        async function callApi(text, imageBase64, imageMime) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000);
            
            try {
                const res = await fetch('https://silly-dusk-3fa302.netlify.app/.netlify/functions/chat, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, imageBase64, imageMime }),
                    signal: controller.signal
                });

                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                
                const data = await res.json();
                return data;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // Main Handler
        fileInput.addEventListener('change', async function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                await processAnalysis(file);
            }
        });

        async function handleNoImageAnalysis() {
            await processAnalysis(null);
        }

        async function processAnalysis(file) {
            // UI Init
            screenHome.classList.add('hidden');
            screenLoading.classList.remove('hidden');
            resultContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            errorRaw.innerText = '';
            
            // Set Loading Preview
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewLoading.src = e.target.result;
                    previewResult.src = e.target.result;
                    previewResult.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewLoading.src = ''; // No image placeholder logic
                previewResult.style.display = 'none'; // Hide if no image
            }

            try {
                let imgData = { base64: null, mime: null };
                if (file) {
                    imgData = await resizeImage(file);
                    // Use resized image for final preview as well
                    previewResult.src = imgData.preview;
                }

                const text = inputText.value.trim();
                const response = await callApi(text, imgData.base64, imgData.mime);

                if (response.error) {
                    throw new Error(response.error); // Catch block will handle raw if needed logic
                }
                
                // Show Result
                resultTitle.innerText = response.title || 'タイトル生成なし';
                resultPost.innerText = response.post || '投稿文生成なし';
                resultHashtags.innerText = (response.hashtags || []).join(' ');
                resultCta.innerText = response.cta || 'ぜひご来店ください';

                screenLoading.classList.add('hidden');
                screenResult.classList.remove('hidden');

            } catch (err) {
                console.error('Analysis Failed:', err);
                
                screenLoading.classList.add('hidden');
                screenResult.classList.remove('hidden');
                resultContainer.classList.add('hidden'); // Hide success card
                errorContainer.classList.remove('hidden');
                
                errorMessage.innerText = '生成に失敗しました';
                errorRaw.innerText = err.message + (err.raw ? `\n\nRaw: ${err.raw}` : '');
            } finally {
                // Reset file input to allow re-selection of same file
                fileInput.value = '';
            }
        }

        function toggleRawError() {
            if (errorRaw.style.display === 'block') {
                errorRaw.style.display = 'none';
            } else {
                errorRaw.style.display = 'block';
            }
        }

        function resetApp() {
            inputText.value = '';
            fileInput.value = '';
            screenResult.classList.add('hidden');
            screenHome.classList.remove('hidden');
        }

        // Copy Functions
        function copyAll() {
            const btn = document.getElementById('btn-copy-all');
            const originalContent = btn.innerHTML;
            const text = `${resultTitle.innerText}\n\n${resultPost.innerText}\n\n${resultHashtags.innerText}\n\n${resultCta.innerText}`;
            
            execCopy(text, btn, originalContent);
        }

        function copyTitle() {
            const btn = document.getElementById('btn-copy-title');
            const originalContent = btn.innerHTML;
            const text = resultTitle.innerText;
            
            execCopy(text, btn, originalContent);
        }

        function execCopy(text, btn, originalContent) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i><span class="font-bold">OK!</span>`;
                btn.style.backgroundColor = "#10B981";
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.backgroundColor = "";
                    lucide.createIcons();
                }, 1500);
            } catch (err) {
                console.error('Copy failed', err);
            }
            document.body.removeChild(textArea);
        }

        function openSNS(platform) {
            const fullText = `${resultTitle.innerText}\n${resultPost.innerText}\n${resultHashtags.innerText}`;
            const text = encodeURIComponent(fullText);
            
            if (userSettings.urls[platform]) {
                window.open(userSettings.urls[platform], '_blank');
                return;
            }
            
            let url = '';
            switch(platform) {
                case 'twitter': url = `https://twitter.com/intent/tweet?text=${text}`; break;
                case 'line': url = `https://line.me/R/msg/text/?${text}`; break;
                case 'instagram': url = 'instagram://app'; break;
                case 'facebook': url = 'https://www.facebook.com/'; break;
            }
            if (url) window.open(url, '_blank');
        }
    </script>
</body>
</html>
